<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Keuangan</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon.png">

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<style>
  body {
    -webkit-tap-highlight-color: transparent;
  }
  .updated {
    animation: flash 0.8s ease;
  }
  @keyframes flash {
    0%   { background-color: rgba(59,130,246,0.35); }
    100% { background-color: transparent; }
  }
  /* =========================
   CUSTOM SCROLLBAR (PILL)
   ========================= */
  /* Chrome, Edge, Safari */
  #tabelData::-webkit-scrollbar {
    width: 8px;
  }
  #tabelData::-webkit-scrollbar-track {
    background: transparent;
  }
  #tabelData::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 999px;
  }
  #tabelData::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.45);
  }
  /* Firefox */
  #tabelData {
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,.35) transparent;
  }
  #tabelData::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,.15);
    transition: background .3s;
  }
  #tabelData:hover::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,.4);
  }
  #tabelData {
    scroll-behavior: smooth;
  }
  /* =====================
   EDIT MODE LOCK
   ===================== */
  body.editing * {
    pointer-events: none;
  }
  body.editing form,
  body.editing form * {
    pointer-events: auto;
  }
  #uiLock {
    pointer-events: none;
  }
  .edit-active {
    position: relative;
    z-index: 50;
  }
  #saldoSlider {
    will-change: transform;
  }
</style>

<script>
  function updateWalletUI() {
    document
      .querySelectorAll('.wallet-btn')
      .forEach(b => b.classList.remove('bg-blue-600'));

    document
      .getElementById('btn-' + activeWallet)
      .classList.add('bg-blue-600');
  }
</script>

</head>

<body class="bg-gradient-to-b from-gray-900 to-black text-gray-100 min-h-screen">

<!-- APP WRAPPER -->
<div class="max-w-7xl mx-auto px-4 pt-6 pb-6
            lg:grid lg:grid-cols-2 lg:gap-8">

<div class="lg:sticky lg:top-6 lg:self-start">  
<!-- HEADER -->
  <header class="mb-6">
    <h1 id="headerTitle" class="text-2xl font-semibold">Keuangan</h1>
    <p id="headerSub" class="text-gray-400 text-sm">Ringkasan hari ini</p>
  </header>

  <!-- SALDO CARD -->
  <div class="relative group overflow-hidden bg-white/10 backdrop-blur-xl rounded-3xl mb-6 shadow-lg">
    <div id="saldoSlider"
        class="flex w-full transition-transform duration-300 ease-out touch-pan-y">
    </div>
      <!-- Arrow -->
      <button onclick="nextWallet()"
        class="absolute right-5 top-1/2 -translate-y-1/2 z-10
              w-9 h-9 rounded-full
              bg-white/10 hover:bg-white/20
              opacity-0 pointer-events-none
              group-hover:opacity-100 group-hover:pointer-events-auto
              transition-all duration-300
              group-hover:translate-x-1">
        <i class="bi bi-arrow-right-circle"></i>
      </button>
      <!-- SLIDER -->
      <div id="saldoSlider"
          class="flex transition-transform duration-300 ease-out">
      </div>
  </div>

  <!-- INPUT -->
  <form onsubmit="simpan(); return false;" class="bg-white/5 rounded-3xl p-4 mb-6 space-y-3">
    <input id="tanggal" type="date"
        class="w-full bg-transparent p-3 rounded-xl border border-white/10">
    <input id="jumlah" placeholder="+ / - Rp"
        class="w-full bg-transparent p-3 rounded-xl border border-white/10">
    <input id="keterangan" placeholder="Keterangan"
        class="w-full bg-transparent p-3 rounded-xl border border-white/10">
    <button
        class="w-full bg-blue-600 active:bg-blue-700 transition rounded-2xl py-3 font-semibold">
        Simpan
    </button>
    <button
    type="button"
    id="btnCancel"
    onclick="cancelEdit()"
    class="w-full border border-white/20
          rounded-2xl py-3 font-semibold
          text-gray-300 hidden">
    Batal
  </button>
  </form>
</div>

    <!-- LIST -->
    <div>
        <h2 class="text-lg font-semibold mb-3">Riwayat Transaksi</h2>
        <div id="tabelData" class="space-y-3 max-h-[70vh] lg:max-h-[80vh] overflow-y-auto 
            pr-1 scrollbar-thin scrollbar-thumb-white/10">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vowavdndypyalhrjrgga.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvd2F2ZG5keXB5YWxocmpyZ2dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyODc1NTIsImV4cCI6MjA4NTg2MzU1Mn0.RbGMObO3UnfGhwciFfKkZyhXYC4Bth7_oNCeGRwfM_s";
  window.db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function syncFromSupabase() {
  const { data: rows, error } = await db
    .from('keuangan')
    .select('*')
    .order('created_at', { ascending: false });
  if (error) {
    console.warn('Supabase offline, pakai local');
    return;
  }
  data = rows.map(r => ({
    id: r.id,
    tanggal: r.tanggal,
    keterangan: r.keterangan,
    jumlah: r.jumlah
  }));
  localStorage.setItem('keuangan', JSON.stringify(data));
  render();
}

let data = [];
let editIndex = null;
let editId = null;
let collapsedDates = JSON.parse(
  localStorage.getItem('collapsedDates') || '{}'
);
let activeWallet = 'BRI';
let isEditing = false;

const tanggalEl = document.getElementById('tanggal');
const jumlahEl = document.getElementById('jumlah');
const ketEl = document.getElementById('keterangan');

window.onload = async () => {
  tanggalEl.valueAsDate = new Date();
  // load local dulu (instant)
  const local = JSON.parse(localStorage.getItem('keuangan')) || [];
  data = local;
  activeWallet =
    localStorage.getItem('activeWallet') || 'BRI';
  walletIndex = wallets.indexOf(activeWallet);
  if (walletIndex < 0) walletIndex = 0;
  updateWalletTitle();
  render();
  renderSaldoSlider();   // üîë penting
  // sync dari Supabase
  await loadFromSupabase();
};

async function loadFromSupabase() {
  const { data: rows, error } = await window.db
    .from('keuangan')
    .select('*')
    .order('created_at', { ascending: false });
  if (error) {
    console.warn(error);
    return;
  }
  data = rows.map(r => ({
    id: r.id,              // üîë WAJIB
    tanggal: r.tanggal,
    keterangan: r.keterangan,
    jumlah: r.jumlah,
    wallet: r.wallet || 'BRI'
  }));
  localStorage.setItem('keuangan', JSON.stringify(data));
  render();
}

function formatTanggalIndo(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('id-ID', {
    weekday: 'long',
    day: '2-digit',
    month: 'long',
    year: 'numeric'
  });
}

function toggleTanggal(tanggal) {
  collapsedDates[tanggal] = !collapsedDates[tanggal];
  localStorage.setItem(
    'collapsedDates',
    JSON.stringify(collapsedDates)
  );
  render();
}

function formatRupiah(n) {
  return 'Rp ' + n.toLocaleString('id-ID');
}

function parseJumlah(str) {
  const neg = str.trim().startsWith('-');
  const num = Number(str.replace(/[^0-9]/g,'')) || 0;
  return neg ? -num : num;
}

jumlahEl.addEventListener('input', (e) => {
  let raw = e.target.value;
  // detect minus
  const isNegative = raw.trim().startsWith('-');
  // ambil angka aja
  let number = raw.replace(/[^0-9]/g, '');
  if (number === '') {
    e.target.value = isNegative ? '-' : '';
    return;
  }
  let formatted = Number(number).toLocaleString('id-ID');
  e.target.value = (isNegative ? '- Rp ' : 'Rp ') + formatted;
  // warna realtime
  e.target.classList.remove('text-red-400', 'text-green-400');
  e.target.classList.add(isNegative ? 'text-red-400' : 'text-green-400');
  // jaga cursor di akhir (UX paling natural untuk rupiah)
  e.target.setSelectionRange(
    e.target.value.length,
    e.target.value.length
  );
});

console.log('db READY?', db);

async function simpan() {
  const jumlah = parseJumlah(jumlahEl.value);
  if (!tanggalEl.value || !ketEl.value || jumlah === 0) {
    alert('Data belum lengkap');
    return;
  }
  // =========================
  // MODE EDIT
  // =========================
  if (editId !== null) {
    const idx = editIndex;
    const id = editId;
    const oldData = { ...data[idx] };

    // ambil value SEKARANG (sebelum reset)
    const newTanggal = tanggalEl.value;
    const newKet = ketEl.value;
    const newJumlah = jumlah;

    // optimistic UI
    data[idx] = {
      ...oldData,
      tanggal: newTanggal,
      keterangan: newKet,
      jumlah: newJumlah
    };
    localStorage.setItem('keuangan', JSON.stringify(data));
    render();

    // =====================
    // SAFE UPDATE SUPABASE
    // =====================
    const updates = {};

    if (oldData.tanggal !== newTanggal) {
      updates.tanggal = newTanggal;
    }
    if (oldData.keterangan !== newKet) {
      updates.keterangan = newKet;
    }
    if (oldData.jumlah !== newJumlah) {
      updates.jumlah = newJumlah;
    }

    if (Object.keys(updates).length > 0) {
      const { error } = await db
        .from('keuangan')
        .update(updates)
        .eq('id', id);

      if (error) {
        console.error(error);
        alert('Gagal sync, perubahan dibatalkan');
        data[idx] = oldData;
        localStorage.setItem('keuangan', JSON.stringify(data));
        render();
      }
    }

    // üîª BARU RESET & UNLOCK SETELAH UPDATE
    exitEditMode();
    reset();

    return;
  }
  // =========================
  // MODE TAMBAH
  // =========================
  console.log('INSERT TRY');
  const { data: inserted, error } = await db
    .from('keuangan')
    .insert({
      tanggal: tanggalEl.value,
      keterangan: ketEl.value,
      jumlah,
      wallet: activeWallet
    })
    .select()
    .single();
  if (error) {
    alert('Insert gagal');
    console.error(error);
    return;
  }
  data.unshift(inserted);
  localStorage.setItem('keuangan', JSON.stringify(data));
  reset();
  render();
}

function reset() {
  tanggalEl.valueAsDate = new Date();
  jumlahEl.value = '';
  ketEl.value = '';
  editIndex = null;
  editId = null; // üîë PENTING
  document.getElementById('headerTitle').innerText = 'Keuangan';
  document.getElementById('headerSub').innerText = 'Ringkasan hari ini';
  isEditing = false;
  document.getElementById('btnCancel').classList.add('hidden');
}

function render() {
  let masuk = 0, keluar = 0;
  const wrap = document.getElementById('tabelData');
  const filtered = data.filter(
    d => d.wallet === activeWallet
  );

  wrap.innerHTML = '';

  // ======================
  // GROUP BY TANGGAL
  // ======================
  const groups = {};
  filtered.forEach((d, index) => {
    if (!groups[d.tanggal]) groups[d.tanggal] = [];
    groups[d.tanggal].push({ ...d, _index: index });

    d.jumlah >= 0
      ? masuk += d.jumlah
      : keluar += Math.abs(d.jumlah);
  });

  // ======================
  // RENDER PER TANGGAL
  // ======================
  Object.keys(groups)
    .sort((a, b) => b.localeCompare(a))
    .forEach(tanggal => {
      const isCollapsed = collapsedDates[tanggal];

      const today = new Date().toISOString().slice(0,10);
      if (!(tanggal in collapsedDates)) {
        collapsedDates[tanggal] = tanggal !== today;
      }

      // üîπ TOTAL PER TANGGAL
      const totalTanggal = groups[tanggal]
        .reduce((s, d) => s + d.jumlah, 0);

      wrap.innerHTML += `
        <div class="mb-3">
          <button
            onclick="toggleTanggal('${tanggal}')"
            class="w-full flex justify-between items-center
                   text-sm font-semibold
                   bg-white/0 hover:bg-white/5
                   px-4 py-3 rounded-2xl transition">

            <div class="flex flex-col text-left">
              <span>${formatTanggalIndo(tanggal)}</span>
              <span class="text-xs opacity-60">
                ${groups[tanggal].length} transaksi
              </span>
            </div>

            <div class="flex items-center gap-3">
              <span class="
                text-xs font-semibold px-3 py-1 rounded-full
                ${totalTanggal < 0
                  ? 'bg-red-500/20 text-red-400'
                  : 'bg-green-500/20 text-green-400'}">
                ${totalTanggal < 0 ? '-' : '+'}
                ${formatRupiah(Math.abs(totalTanggal))}
              </span>

              <span class="text-xs opacity-70">
                ${isCollapsed ? '‚ñ∂' : '‚ñº'}
              </span>
            </div>
          </button>

          <div
            class="mt-3 space-y-3
                   ${isCollapsed ? 'hidden' : ''}"
            data-date="${tanggal}">
          </div>
        </div>
      `;

      const container = wrap.querySelector(
        `[data-date="${tanggal}"]`
      );

      // ======================
      // ISI TRANSAKSI
      // ======================
      groups[tanggal].forEach(d => {
        container.innerHTML += `
          <div class="relative group overflow-hidden rounded-2xl"
               data-id="${d.id}">
            <!-- ACTION -->
            <div class="absolute right-0 top-0 h-full flex items-center gap-2 px-3
                        bg-black/40 backdrop-blur-xl
                        translate-x-full group-hover:translate-x-0
                        transition-transform duration-300">
              <button data-id="${d.id}"
                class="btn-edit w-9 h-9 rounded-xl bg-blue-500/20 pointer-events-auto">‚úèÔ∏è</button>
              <button data-id="${d.id}"
                class="btn-delete w-9 h-9 rounded-xl bg-red-500/20 pointer-events-auto">üóëÔ∏è</button>
            </div>

            <!-- CARD -->
            <div class="bg-white/5 p-4 pr-24 flex justify-between items-center
                        group-hover:-translate-x-20 transition
                        group-hover:pointer-events-none">
              <div>
                <p class="text-sm">${d.keterangan}</p>
                <p class="text-xs text-gray-400">${d.tanggal}</p>
              </div>
              <p class="${d.jumlah < 0 ? 'text-red-400' : 'text-green-400'} font-medium">
                ${d.jumlah < 0 ? '-' : ''}${formatRupiah(Math.abs(d.jumlah))}
              </p>
            </div>
          </div>
        `;
      });
    });

  totalMasuk.innerText = formatRupiah(masuk);
  totalKeluar.innerText = formatRupiah(keluar);
  saldo.innerText = formatRupiah(masuk - keluar);
}

function editData(i) {
  editIndex = i;
  const d = data[i];
  // üîë simpan ID supabase
  editId = d.id;
  tanggalEl.value = d.tanggal;
  ketEl.value = d.keterangan;
  jumlahEl.value =
    (d.jumlah < 0 ? '- Rp ' : 'Rp ') +
    Math.abs(d.jumlah).toLocaleString('id-ID');
  jumlahEl.className =
    'w-full bg-transparent p-3 rounded-xl border border-white/10 ' +
    (d.jumlah < 0 ? 'text-red-400' : 'text-green-400');
  document.getElementById('headerTitle').innerText = 'Edit Transaksi';
  document.getElementById('headerSub').innerText =
    'Perbarui data lalu tekan Simpan';
  isEditing = true;
  document.getElementById('btnCancel').classList.remove('hidden');
  document.body.classList.add('editing');
}

function editDataById(id) {
  if (!id) return;
  const i = data.findIndex(d => String(d.id) === String(id));
  if (i === -1) return;
  editData(i);
}

let lastDeleted = null;
let toastTimer = null;

async function hapusData(i) {
  const item = data[i];
  lastDeleted = { ...item, index: i };
  // local delete
  data.splice(i, 1);
  localStorage.setItem('keuangan', JSON.stringify(data));
  render();
  showToast();
  // supabase delete
  if (item.id) {
    await window.db
      .from('keuangan')
      .delete()
      .eq('id', item.id);
  }
  console.log('DELETE TRY');
}

function hapusDataById(id) {
  if (!id) return;
  const i = data.findIndex(d => String(d.id) === String(id));
  if (i === -1) return;
  hapusData(i);
}

function showToast() {
  const t = document.getElementById('toast');
  t.classList.remove('hidden');

  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    t.classList.add('hidden');
    lastDeleted = null;
  }, 4000);
}

function undoDelete() {
  if (!lastDeleted) return;
  data.splice(lastDeleted.index, 0, lastDeleted);
  localStorage.setItem('keuangan', JSON.stringify(data));
  lastDeleted = null;
  document.getElementById('toast').classList.add('hidden');
  render();
}

let startX = 0;
let swipedIndex = null;

function onTouchStart(e, i) {
  startX = e.touches[0].clientX;
  swipedIndex = i;
}

function onTouchEnd(e) {
  const endX = e.changedTouches[0].clientX;
  if (startX - endX > 80 && swipedIndex !== null) {
    hapusData(swipedIndex);
    swipedIndex = null;
  }
}

function setWallet(w) {
  console.log('SWITCH WALLET:', w);
  if (isEditing) return;
  activeWallet = w;
  localStorage.setItem('activeWallet', w);
  updateWalletTitle();
  updateWalletUI();
  render();
}

document.addEventListener('click', (e) => {
  const editBtn = e.target.closest('.btn-edit');
  const delBtn  = e.target.closest('.btn-delete');

  if (editBtn) {
    const id = editBtn.dataset.id;
    editDataById(id);
  }

  if (delBtn) {
    const id = delBtn.dataset.id;
    hapusDataById(id);
  }
});

function updateWalletTitle() {
  const title = document.getElementById("headerTitle");
  if (!title) return;

  title.innerHTML = `
    Keuangan ¬∑
    <span class="text-2xl font-semibold px-2 py-0 rounded-xl bg-white/5">
      ${activeWallet}
    </span>
  `;
}

function cancelEdit() {
  reset();
  exitEditMode();
}

function exitEditMode() {
  isEditing = false;
  document.body.classList.remove('editing');
  document.getElementById('btnCancel').classList.add('hidden');
}

const wallets = ['BRI', 'Maybank'];
let walletIndex = 0;
renderSaldoSlider();

function renderSaldoSlider() {
  const slider = document.getElementById('saldoSlider');
  if (!slider) return;

  slider.innerHTML = '';

  wallets.forEach(w => {
    const filtered = data.filter(d => d.wallet === w);

    let masuk = 0, keluar = 0;
    filtered.forEach(d => {
      d.jumlah >= 0
        ? masuk += d.jumlah
        : keluar += Math.abs(d.jumlah);
    });

    const saldo = masuk - keluar;

    slider.innerHTML += `
      <div class="min-w-full">
        <div class="bg-gray-800 rounded-3xl p-6 shadow-lg">
          <p class="text-gray-400 text-sm">Saldo</p>
          <p class="text-3xl font-bold mt-1">
            ${formatRupiah(saldo)}
          </p>

          <div class="flex justify-between mt-6 text-sm">
            <div>
              <p class="text-gray-400">Masuk</p>
              <p class="text-green-400 font-medium">
                ${formatRupiah(masuk)}
              </p>
            </div>
            <div>
              <p class="text-gray-400">Keluar</p>
              <p class="text-red-400 font-medium">
                ${formatRupiah(keluar)}
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  slider.style.transform =
    `translateX(-${walletIndex * 100}%)`;
}


function nextWallet() {
  if (isEditing) return;
  walletIndex = (walletIndex + 1) % wallets.length;
  syncWallet();
}

function prevWallet() {
  if (isEditing) return;
  walletIndex =
    (walletIndex - 1 + wallets.length) % wallets.length;
  syncWallet();
}

function syncWallet() {
  activeWallet = wallets[walletIndex];
  localStorage.setItem('activeWallet', activeWallet);
  updateWalletTitle();
  renderSaldoSlider();
  render(); // list transaksi
}

let currentIndex = 0;

function renderWallet() {
  const slider = document.getElementById("saldoSlider");
  slider.innerHTML = wallets.map(wallet => `
    <div class="min-w-full px-4">
      <div class="wallet-card">
        <p class="wallet-name">${w}</p>
        <p class="wallet-balance">${saldo}</p>
      </div>
    </div>
  `).join("");
  slider.style.transform = `translateX(-${currentIndex * 100}%)`;
}

async function fetchWallets() {
  const { data, error } = await supabase
    .from("wallets")
    .select("*");
  if (error) {
    console.error(error);
    return;
  }
  wallets = data;
  renderWallet(); // ‚úÖ PINDAHKAN KE SINI
}
document.addEventListener("DOMContentLoaded", () => {
  fetchWallets(); // ‚ùå jangan render di luar
});

let currentX = 0;
let isDragging = false;

const slider = document.getElementById("saldoSlider");

slider.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
  isDragging = true;
  slider.style.transition = "none";
});

slider.addEventListener("touchmove", e => {
  if (!isDragging) return;

  currentX = e.touches[0].clientX;
  const diff = currentX - startX;

  slider.style.transform =
    `translateX(calc(-${currentIndex * 100}% + ${diff}px))`;
});

slider.addEventListener("touchend", () => {
  if (!isDragging) return;
  isDragging = false;

  const diff = currentX - startX;
  const threshold = slider.offsetWidth * 0.25;

  if (diff < -threshold && currentIndex < wallets.length - 1) {
    currentIndex++;
  } else if (diff > threshold && currentIndex > 0) {
    currentIndex--;
  }

  slider.style.transition = "transform 0.3s ease";
  updateSlide();
});


function updateSlide() {
  slider.style.transform =
    `translateX(-${currentIndex * 100}%)`;
}

</script>

<div id="toast"
 class="fixed bottom-6 left-1/2 -translate-x-1/2
        bg-black/80 backdrop-blur-xl text-sm
        px-4 py-3 rounded-2xl shadow-lg
        hidden flex items-center gap-4">
  <span>Transaksi dihapus</span>
  <button onclick="undoDelete()" class="text-blue-400 font-medium">UNDO</button>
</div>

</body>
</html>
